---
title: "hold_out_phenotype_prediction_plots.Rmd"
author: "Eva"
date: "2023-02-08"
output: html_document
---

```{r}
library(Rcpp)

library(stringr)
library(arrow)
library(yardstick)
library(ggplot2)
library(gdata)
library(dplyr)
library(tidyr)
library(purrr)
library(ggpubr)
library(latex2exp)
library(cowplot)

options(dplyr.summarise.inform = FALSE)

library(gridExtra)
library(grid)

phenotypes = c("Apolipoprotein_A", 
               "Apolipoprotein_B", 
               "Calcium", 
               "Cholesterol",
               "HDL_cholesterol",
               "IGF_1" ,
               "LDL_direct",
               "Lymphocyte_percentage",
               "Mean_corpuscular_volume",
               "Mean_platelet_thrombocyte_volume",
               "Mean_reticulocyte_volume",
               "Neutrophill_count",
               "Platelet_count",
               "Platelet_crit",
               "Platelet_distribution_width",
               "Red_blood_cell_erythrocyte_count",
               "SHBG",
               "Standing_height",
               "Triglycerides",
               "Total_bilirubin",
               "Urate"
)

phenotype_renamer = c(
    'Mean_platelet_thrombocyte_volume' = 'MPTVS',
    'IGF_1' = 'IGF-1',
    'Red_blood_cell_erythrocyte_count' = 'Erythrocyte count'
)

phenotype_dict = c()
for (p in phenotypes){
  if (! p %in% names(phenotype_renamer)){
    p_name = str_replace_all(p, '_', ' ')
  }
  else{
    p_name = phenotype_renamer[[p]]
  }
  phenotype_dict[[p]] = p_name
}



```

The experiment directory should have two sub-directories e.g., "multipheno_cv" and "multipheno_cv_hold_out_pheno" where phenotype_prediction_pipeline.snakefile and phenotype_prediction_pipeline_hold_out_pheno.snakefile have been run, respectively. 

```{r}
plot_out_path = "./plots"
experiment_directory = #"PATH_TO_EXPERIMENT"

exp_names = c('multipheno_cv' = 'Multipheno', 'multipheno_cv_hold_out_pheno' = 'Hold-out pheno')

```


```{r}
linear_model_res_path = file.path(experiment_directory,'multipheno_cv/phenotype_prediction/models/linear_models/')
fdr = 0.05
phenotype_suffix = 'qt'
phenotypes <- phenotypes[file.exists(paste0(linear_model_res_path, '/', phenotypes, '/', phenotype_suffix, '_fdr-', fdr, '.Rds'))]

# phenotypes <- phenotypes[file.exists(paste0(linear_model_res_path, '/', phenotypes, '/', phenotype_suffix, '_fdr-', fdr, '.Rds'))]

```


## analyse metrics

```{r}
burdens_to_exclude = c('cadd_10', 'cadd_20', 'polyphen_damaging')
paste(burdens_to_exclude, collapse = '|')
all_combined_metrics = readRDS(file.path(linear_model_res_path, 'plotting_data', paste0('all_recomputed_metrics_test_', phenotype_suffix, '_', fdr,'.Rds'))) %>%
  filter(!grepl(paste(burdens_to_exclude, collapse = '|'), model_name))
all_combined_metrics %>% distinct(model_name)
```

```{r}
baseline_btypes = unique(sapply(strsplit(grep('baseline-', all_combined_metrics %>% distinct(model_name) %>% pull(model_name), value = TRUE), "-"), function(x) x[2]))

baseline_methods =  paste('baseline', baseline_btypes, sep = '-')
method_gene_list_filter = quo((`rare_burden` %in% baseline_methods & gene_list == 'baseline_only') | (`rare_burden` == 'deeprvat-avg' & gene_list == 'deeprvat_discoveries'))
method_gene_list_filter
```


## Plotting 
```{r}
method_names = c(#'baseline-cadd_10' = 'CADD >10', 
                 #'baseline-cadd_20' = 'CADD >20', 
                  "baseline-cadd" = 'CADD',
                 "baseline-plof" = 'pLOF',
                 #"baseline-polyphen_damaging" = 'PolyPhen2 Probably Damaging',
                 "baseline-polyphen" = 'PolyPhen2',
                "baseline-primateai" = 'PrimateAI',
                "baseline-sift"= 'SIFT',
                "baseline-splicai" = 'SpliceAI',
                'deeprvat-avg' = 'DeepRVAT',
                'covariates-PRS' = 'common PRS')

viridis_colors = viridis::viridis(n = length(baseline_methods) + 4)
deeprvat_color = '#7A2961'
common_prs_color = 'darkgoldenrod2'

color_mapping = c(tail(viridis_colors, -4), deeprvat_color, common_prs_color)
names(color_mapping) = names(method_names)


color_mapping_sub = color_mapping[grep('_', names(color_mapping), invert = TRUE)]

rare_method_fill = scale_fill_manual(values = color_mapping)
rare_method_color = scale_fill_manual(values = color_mapping)

RmUnderscore <- function(string) {
  sub("_", " ", string)
}
remove_x_underscore = scale_x_discrete(labels = ~ gsub("_", " ", .x)) 
remove_y_expand = scale_y_continuous(labels = scales::percent, expand =  expansion(mult = c(0, 0.1)))
```


run make_linear_regression_models.R to fit the regression models 


# Evaluate from here


# Recompute R2 for aggregated test samples

```{r}
IndexDF <- function(this_deeprvat_name){
  this_res = res %>% filter(model_name == this_deeprvat_name)
  this_res$index <- 1:nrow(this_res)
  return(this_res)
}

```




## Prepare metrics for plotting
```{r}
model_order = c("covariates", "covariates-PRS", baseline_methods, "deeprvat-avg") #, "deeprvat-0","deeprvat-1","deeprvat-2","deeprvat-3","deeprvat-4","deeprvat-5")
model_order


```


```{r}
compared_res_linear = tibble()
for (this_exp_name in names(exp_names)){

  linear_model_res_path = file.path(experiment_directory, this_exp_name ,'phenotype_prediction/models/linear_models/')

  all_combined_metrics = readRDS(file.path(linear_model_res_path, 'plotting_data', paste0('all_recomputed_metrics_test_', phenotype_suffix, '_', fdr,'.Rds'))) %>%
    filter(!grepl(paste(burdens_to_exclude, collapse = '|'), model_name))
  all_combined_metrics %>% distinct(model_name)
  
  all_combined_metrics = all_combined_metrics %>% mutate(gene_list = ifelse(grepl('covariates', model_name), 'None', str_split(model_name, '-',  simplify = TRUE)[,3]))
  
  covariates_res = all_combined_metrics %>% filter(grepl('covariates', model_name))
  for (this_gene_list in unique(all_combined_metrics$gene_list)){
    all_combined_metrics = rbind(all_combined_metrics, covariates_res %>% mutate(gene_list = this_gene_list))
  }
  covariates_res
  
  all_combined_metrics =  all_combined_metrics %>% 
    separate(model_name, c('one', 'two', 'three'), sep = '-', remove = FALSE) %>%
    mutate(model = paste(one, two, sep = '-')) %>% select(-one, -two, -three, -method) %>%
    mutate(model = str_replace(model, "covariates-NA", "covariates")) %>%
    filter(!grepl('None', gene_list))  %>%
    select(-top_quantile) %>%
    filter(model %in% model_order)
  all_combined_metrics[['model']] =  factor(all_combined_metrics[['model']], model_order)
  all_combined_metrics = all_combined_metrics %>%
    mutate(exp_name = this_exp_name, name = exp_names[[this_exp_name]])
  compared_res_linear = rbind(compared_res_linear, all_combined_metrics)
}
compared_res_linear %>% distinct(exp_name)
all_combined_metrics %>% distinct(model)
```





```{r}
compared_res_logistic = tibble()
for (this_exp_name in names(exp_names)){

  logistic_model_res_path = logistic_model_res_path = file.path(experiment_directory, this_exp_name, 'phenotype_prediction/models/logistic_models/')
  logistic_model_metrics = readRDS(file.path(logistic_model_res_path, 'plotting_data', paste0('combined_metrics_', phenotype_suffix, '_', fdr,'.Rds')))

  logistic_model_metrics = logistic_model_metrics %>% 
    mutate(model_name = sub('deeprvat-', 'deeprvat-avg-', model_name)) %>%
    separate(col = model_name, into = c('burden', 'vtype_repeat', 'gene_list'), sep = '-', remove = FALSE) %>%
    filter(!grepl('_', vtype_repeat)) %>% #remove cadd_10 ..
    mutate(rare_burden = paste(burden, vtype_repeat, sep = '-'))
  logistic_model_metrics %>% distinct(vtype_repeat)
  logistic_model_metrics %>% distinct(rare_burden)
  
  
  covariates_res = logistic_model_metrics %>% filter(grepl('covariates', model_name))
  for (this_gene_list in na.omit(unique(logistic_model_metrics$gene_list))){
    logistic_model_metrics = rbind(logistic_model_metrics, covariates_res %>% mutate(gene_list = this_gene_list))
  }
  logistic_model_metrics = drop_na(logistic_model_metrics, gene_list) %>%
    mutate(exp_name = this_exp_name, name = exp_names[[this_exp_name]])
  compared_res_logistic = rbind(compared_res_logistic, logistic_model_metrics)
}
compared_res_logistic %>% distinct(rare_burden)
```


```{r}
x_label = 'All phenotypes relative'
y_label = 'Held-out phenotype relative'

```

```{r}
#performance drop for relative metric (relative to common PRS)
metric_name = 'AUPRC'
plot_df_rel_logistic = compared_res_logistic %>% 
  filter((rare_burden == 'deeprvat-avg' & gene_list == 'deeprvat_discoveries') | (rare_burden == 'covariates-PRS' & gene_list == 'deeprvat_discoveries')) %>% 
  select(-exp_name, -gene_list, -model_name, -burden, -vtype_repeat) %>%
  pivot_wider(values_from = .estimate, names_from = rare_burden) %>%
  mutate(ratio_r2 = `deeprvat-avg` - `covariates-PRS`) %>%
  mutate(ratio_r2 = ratio_r2/`covariates-PRS` ) %>%
  select(-`deeprvat-avg`, - `covariates-PRS`) %>%
  pivot_wider(values_from = ratio_r2, names_from = name) %>%
  mutate(diff = `Hold-out pheno` - Multipheno,
         abs_diff = abs(diff)) %>%
  filter(.metric == 'pr_auc') %>% filter(top_quantile == 0.01)

plot_df_rel_logistic


max_val_logistic = round(max(max(plot_df_rel_logistic $Multipheno), max(plot_df_rel_logistic$`Hold-out pheno`)), 1)
max_val_logistic

p_rel_logistic = ggplot(plot_df_rel_logistic ,
       aes(x = Multipheno, y = `Hold-out pheno`, color = extreme_direction)) +
  geom_point() +
  # facet_grid(cols = vars(extreme_direction)) +
  #facet_grid(rows = vars(top_quantile), cols = vars(extreme_direction)) +
  geom_abline(intercept=0, slope=1, color='lightgray', linewidth=0.5) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +#,  limits = c(0, max_val_logistic)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + #,  limits = c(0, max_val_logistic)) +
  labs(color = '', x = paste(x_label, metric_name), y = paste(y_label, metric_name)) +
  scale_color_brewer(palette = "Paired", limits = c('bottomq', 'topq'), 
                     labels = c('Bottom 1%', 'Top 1%')) +
  labs(x = TeX(r'(All phenotypes relative $\Delta$AUPRC)'), y = TeX(r'(Held-out phenotype relative $\Delta$AUPRC)'), color = '') +
  theme_cowplot() +
  theme(legend.position = c(.1, .8)) +
  coord_fixed(ratio = 1)

p_rel_logistic
saveRDS(p_rel_logistic, 'p_rel_logistic.Rds')
```


```{r}
metric_name = TeX(r'($R^2$)')
plot_df_rel_lin= compared_res_linear %>% 
  filter((model == 'deeprvat-avg' & gene_list == 'deeprvat_discoveries') | (model == 'covariates-PRS' & gene_list == 'deeprvat_discoveries')) %>% 
  select(-exp_name, -gene_list, -model_name) %>%
  pivot_wider(values_from = .estimate, names_from = model) %>%
  mutate(ratio_r2 = `deeprvat-avg` - `covariates-PRS`) %>%
  mutate(ratio_r2 = ratio_r2/`covariates-PRS` ) %>%
  select(-`deeprvat-avg`, - `covariates-PRS`) %>%
  pivot_wider(values_from = ratio_r2, names_from = name) %>%
  mutate(diff = `Hold-out pheno` - Multipheno,
         abs_diff = abs(diff)) %>%
  filter(.metric == 'rsq')

plot_df_rel_lin
max_val_lin = round(max(max(plot_df_rel_lin$Multipheno), max(plot_df_rel_lin$`Hold-out pheno`)), 3)
p_rel_linear = ggplot(plot_df_rel_lin, #filter(model == 'deeprvat-avg' & gene_list == 'deeprvat_discoveries'),
       aes(x = Multipheno, y = `Hold-out pheno`)) +
  geom_point() +
  # facet_grid(cols = vars(gene_list), rows = vars(model)) + 
  geom_abline(intercept=0, slope=1, color='lightgray', linewidth=0.5) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     breaks = seq(0.01, 0.04, by = 0.01),  limits = c(0, max_val_lin)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1),
                     breaks = seq(0.01, 0.04, by = 0.01),  limits = c(0, max_val_lin)) +
  coord_fixed(ratio = 1) +
  labs(x = TeX(r'(All phenotypes relative $\Delta R^2$)'), y = TeX(r'(Held-out phenotype relative $\Delta R^2$)')) +
  theme_cowplot() 
p_rel_linear

saveRDS(p_rel_linear, 'p_rel_linear.Rds')
```


```{r}
p_combined = ggarrange(p_rel_linear, NULL,p_rel_logistic, nrow = 1, 
                       labels = c('a', '', 'b'), widths = c(1,0.1,1))
p_combined
ggsave(file.path(plot_out_path, 'fig_5_cobmbined_relative_hold_out_vs_non_hold_out.png'),p_combined, height = 4.5, width = 9)

```

